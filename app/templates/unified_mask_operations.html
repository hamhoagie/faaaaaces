<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mask Detection & Face Reconstruction Workflow - FAAAAACES</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .workflow-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .step-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .step-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        .step-card.active {
            border-color: #0d6efd;
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
        }
        .step-card.completed {
            border-color: #198754;
            background-color: #f8fff8;
        }
        .step-number {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            margin-right: 20px;
        }
        .step-number.active {
            background-color: #0d6efd;
        }
        .step-number.completed {
            background-color: #198754;
        }
        .video-upload-zone {
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .video-upload-zone:hover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        .video-upload-zone.dragover {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        .face-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .face-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        .face-card.masked {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
        .face-card.unmasked {
            border-color: #198754;
            background-color: #f8fff8;
        }
        .face-card.selected {
            border-color: #0d6efd;
            background-color: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
        }
        .face-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .reconstruction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        .reconstruction-card {
            border: 2px solid #198754;
            border-radius: 12px;
            padding: 20px;
            background: white;
        }
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .comparison-item {
            text-align: center;
        }
        .comparison-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        .progress-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        .workflow-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }
        .workflow-progress::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 30px;
            right: 30px;
            height: 4px;
            background: #e9ecef;
            z-index: 1;
        }
        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            background: white;
            padding: 0 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-user-secret"></i> FAAAAACES
            </a>
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="nav-link active" href="/mask-operations">
                    <i class="fas fa-mask"></i> Mask Detection Workflow
                </a>
            </div>
        </div>
    </nav>

    <main class="container-fluid py-4">
        <div class="workflow-container">
            <!-- Workflow Header -->
            <div class="step-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2"><i class="fas fa-mask"></i> Complete Mask Detection & Face Reconstruction Workflow</h1>
                        <p class="mb-0 opacity-75">Upload videos → Detect masks → Reconstruct faces → Identify individuals</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light btn-lg" onclick="resetWorkflow()">
                            <i class="fas fa-refresh"></i> Start New Workflow
                        </button>
                    </div>
                </div>
            </div>

            <!-- Workflow Progress Indicator -->
            <div class="workflow-progress">
                <div class="workflow-step">
                    <div class="step-number" id="progress-step-1">1</div>
                    <small class="mt-2">Upload Video</small>
                </div>
                <div class="workflow-step">
                    <div class="step-number" id="progress-step-2">2</div>
                    <small class="mt-2">Detect Masks</small>
                </div>
                <div class="workflow-step">
                    <div class="step-number" id="progress-step-3">3</div>
                    <small class="mt-2">Review Results</small>
                </div>
                <div class="workflow-step">
                    <div class="step-number" id="progress-step-4">4</div>
                    <small class="mt-2">Reconstruct Faces</small>
                </div>
                <div class="workflow-step">
                    <div class="step-number" id="progress-step-5">5</div>
                    <small class="mt-2">View Results</small>
                </div>
            </div>

            <!-- Step 1: Video Selection/Upload -->
            <div id="step-1" class="step-card active">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-number active">1</div>
                        <div>
                            <h3 class="mb-1">Select or Upload Video</h3>
                            <p class="text-muted mb-0">Choose an existing video or upload a new one to analyze</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Existing Videos</h5>
                            <select id="video-select" class="form-select form-select-lg mb-3">
                                <option value="">Loading videos...</option>
                            </select>
                            <button class="btn btn-primary btn-lg w-100" onclick="selectExistingVideo()">
                                <i class="fas fa-video"></i> Use Selected Video
                            </button>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Upload New Video</h5>
                            <div class="video-upload-zone" id="upload-zone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Drag & drop video files here</h5>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" id="video-file-input" accept="video/*" style="display: none;">
                                <button class="btn btn-outline-primary btn-lg mt-3" onclick="document.getElementById('video-file-input').click()">
                                    <i class="fas fa-folder-open"></i> Browse Files
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Video URL Option -->
                    <div class="mt-4 pt-4 border-top">
                        <h5>Or Process from URL</h5>
                        <div class="input-group input-group-lg">
                            <input type="url" class="form-control" id="video-url" placeholder="https://youtube.com/watch?v=...">
                            <button class="btn btn-success" onclick="processVideoUrl()">
                                <i class="fas fa-download"></i> Download & Process
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Mask Detection -->
            <div id="step-2" class="step-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-number" id="step-2-number">2</div>
                        <div>
                            <h3 class="mb-1">Mask Detection</h3>
                            <p class="text-muted mb-0">Analyze the video to detect masked and unmasked faces</p>
                        </div>
                    </div>

                    <div id="selected-video-info" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-video"></i> <strong>Selected Video:</strong> <span id="current-video-name"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Detection Options</h5>
                            <div class="form-check form-check-lg mb-3">
                                <input class="form-check-input" type="radio" name="detection-mode" id="mode-full" value="full" checked>
                                <label class="form-check-label" for="mode-full">
                                    <strong>Full Video Analysis</strong><br>
                                    <small class="text-muted">Comprehensive scan of entire video (recommended)</small>
                                </label>
                            </div>
                            <div class="form-check form-check-lg mb-3">
                                <input class="form-check-input" type="radio" name="detection-mode" id="mode-targeted" value="targeted">
                                <label class="form-check-label" for="mode-targeted">
                                    <strong>Targeted Timestamps</strong><br>
                                    <small class="text-muted">Analyze specific time ranges (faster)</small>
                                </label>
                            </div>

                            <div id="timestamp-inputs" style="display: none;">
                                <label class="form-label">Timestamps (seconds)</label>
                                <div class="mb-2" id="timestamp-container">
                                    <input type="number" class="form-control mb-2" placeholder="15.0" step="0.1">
                                    <input type="number" class="form-control mb-2" placeholder="16.0" step="0.1">
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="addTimestamp()">
                                    <i class="fas fa-plus"></i> Add Timestamp
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5>Detection Settings</h5>
                            
                            <div class="mb-3">
                                <label for="confidence-threshold" class="form-label">
                                    <strong>Confidence Threshold</strong>
                                    <small class="text-muted">(Higher = fewer false positives)</small>
                                </label>
                                <div class="d-flex align-items-center">
                                    <input type="range" class="form-range me-3" id="confidence-threshold" 
                                           min="0.5" max="0.9" step="0.05" value="0.7"
                                           oninput="updateConfidenceDisplay(this.value)">
                                    <span id="confidence-display" class="badge bg-primary">0.7</span>
                                </div>
                                <small class="text-muted">Current: <span id="confidence-description">Balanced accuracy</span></small>
                            </div>
                            
                            <button id="start-detection-btn" class="btn btn-success btn-lg w-100" onclick="startDetection()" disabled>
                                <i class="fas fa-search"></i> Start Improved Detection
                            </button>
                        </div>
                    </div>

                    <!-- Progress Indicator -->
                    <div id="detection-progress" class="progress-section" style="display: none;">
                        <h5><i class="fas fa-cog fa-spin"></i> Analyzing Video...</h5>
                        <div class="progress mb-3">
                            <div id="detection-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                        </div>
                        <p id="detection-status">Initializing detection...</p>
                    </div>
                </div>
            </div>

            <!-- Step 3: Detection Results -->
            <div id="step-3" class="step-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-number" id="step-3-number">3</div>
                        <div>
                            <h3 class="mb-1">Detection Results</h3>
                            <p class="text-muted mb-0">Review detected faces and select masked faces for reconstruction</p>
                        </div>
                    </div>

                    <!-- Results Summary -->
                    <div id="detection-results" style="display: none;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h2 id="total-faces-count" class="text-primary mb-2">0</h2>
                                <p class="mb-0">Total Faces</p>
                            </div>
                            <div class="stat-card">
                                <h2 id="masked-faces-count" class="text-danger mb-2">0</h2>
                                <p class="mb-0">Masked Faces</p>
                            </div>
                            <div class="stat-card">
                                <h2 id="unmasked-faces-count" class="text-success mb-2">0</h2>
                                <p class="mb-0">Unmasked Faces</p>
                            </div>
                            <div class="stat-card">
                                <h2 id="mask-detection-rate" class="text-warning mb-2">0%</h2>
                                <p class="mb-0">Detection Rate</p>
                            </div>
                        </div>

                        <!-- Face Selection Controls -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Detected Faces</h5>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary" onclick="filterFaces('all')">All</button>
                                <button class="btn btn-outline-danger" onclick="filterFaces('masked')">Masked Only</button>
                                <button class="btn btn-outline-success" onclick="filterFaces('unmasked')">Unmasked Only</button>
                            </div>
                        </div>

                        <!-- Face Grid -->
                        <div id="faces-grid" class="face-grid">
                            <!-- Face cards will be populated here -->
                        </div>

                        <!-- Continue Button -->
                        <div class="text-center mt-4">
                            <button id="continue-to-reconstruction" class="btn btn-primary btn-lg" onclick="continueToReconstruction()" disabled>
                                <i class="fas fa-arrow-right"></i> Continue to Reconstruction (<span id="selected-count">0</span> faces selected)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Face Reconstruction -->
            <div id="step-4" class="step-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-number" id="step-4-number">4</div>
                        <div>
                            <h3 class="mb-1">Face Reconstruction</h3>
                            <p class="text-muted mb-0">Remove masks and reconstruct the underlying faces</p>
                        </div>
                    </div>

                    <div id="reconstruction-setup" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Reconstruction Options</h5>
                                <div class="mb-3">
                                    <label class="form-label">Reconstruction Method</label>
                                    <select id="reconstruction-method" class="form-select">
                                        <option value="classical">Classical Inpainting (Fast)</option>
                                        <option value="gfpgan">GFPGAN (High Quality)</option>
                                        <option value="codeformer">CodeFormer (Best Results)</option>
                                    </select>
                                    <div class="form-text">Classical is fastest but lower quality. GFPGAN and CodeFormer require additional setup.</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="save-originals" checked>
                                    <label class="form-check-label" for="save-originals">
                                        Keep original masked images
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5>Selected Faces</h5>
                                <div id="selected-faces-preview">
                                    <!-- Preview of selected faces will go here -->
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button id="start-reconstruction-btn" class="btn btn-success btn-lg" onclick="startReconstruction()">
                                <i class="fas fa-magic"></i> Start Face Reconstruction
                            </button>
                        </div>
                    </div>

                    <!-- Reconstruction Progress -->
                    <div id="reconstruction-progress" class="progress-section" style="display: none;">
                        <h5><i class="fas fa-magic fa-spin"></i> Reconstructing Faces...</h5>
                        <div class="progress mb-3">
                            <div id="reconstruction-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                        </div>
                        <p id="reconstruction-status">Preparing face reconstruction...</p>
                    </div>
                </div>
            </div>

            <!-- Step 5: Final Results -->
            <div id="step-5" class="step-card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4">
                        <div class="step-number" id="step-5-number">5</div>
                        <div>
                            <h3 class="mb-1">Reconstruction Results</h3>
                            <p class="text-muted mb-0">Before/after comparisons and final results</p>
                        </div>
                    </div>

                    <div id="final-results" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5>Reconstruction Comparisons</h5>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary" onclick="downloadAllResults()">
                                    <i class="fas fa-download"></i> Download All
                                </button>
                                <button class="btn btn-outline-success" onclick="exportResults()">
                                    <i class="fas fa-file-export"></i> Export Report
                                </button>
                            </div>
                        </div>

                        <div id="reconstruction-grid" class="reconstruction-grid">
                            <!-- Reconstruction comparison cards will be populated here -->
                        </div>

                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg" onclick="resetWorkflow()">
                                <i class="fas fa-refresh"></i> Start New Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Image Gallery Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalTitle">Face Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="imageModalImg" src="" alt="Face image" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadModalImage()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/unified-mask-workflow.js') }}"></script>
</body>
</html>